@page
@model IbhayiPharmacy.Areas.Identity.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "My Profile";
}

<style>
    .profile-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .profile-card {
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: none;
        margin-bottom: 2rem;
    }

    .profile-header {
        background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px 15px 0 0;
        position: relative;
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-right: 1rem;
    }

    .section-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #00aaff;
    }

    .form-control {
        border-radius: 8px;
        padding: 12px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
    }

        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
            border-color: #00aaff;
        }

    .btn-primary {
        background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 170, 255, 0.3);
        }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            color: white;
        }

    .allergy-checkboxes {
        max-height: 200px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #00aaff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .nav-pills .nav-link {
        border-radius: 8px;
        margin-bottom: 5px;
        color: #495057;
        font-weight: 500;
    }

        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%);
            color: white;
        }

    .tab-pane {
        padding: 2rem;
    }

    .readonly-field {
        background-color: #f8f9fa;
        opacity: 1;
    }

    .alert-success {
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }

    .current-allergies {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .allergy-tag {
        display: inline-block;
        background: #00aaff;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        margin: 5px;
        font-size: 0.9rem;
    }

    .is-valid {
        border-color: #28a745 !important;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .valid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #28a745;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

    .was-validated .form-control:valid ~ .valid-feedback,
    .was-validated .form-control:invalid ~ .invalid-feedback {
        display: block;
    }

    .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }

    .home-button-container {
        position: absolute;
        top: 20px;
        right: 20px;
    }
</style>

<div class="profile-container">
    <!-- Success Message -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="profile-card">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="d-flex align-items-center">
                <div class="profile-avatar">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div>
                    <h2 class="mb-1">@Model.Profile.Name @Model.Profile.Surname</h2>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-envelope me-1"></i>@Model.Profile.Email
                        <span class="ms-3">
                            <i class="bi bi-person-check me-1"></i>Valued Customer
                        </span>
                    </p>
                </div>
            </div>

            
        </div>

        <!-- Profile Content -->
        <div class="card-body p-0">
            <div class="row g-0">
                <!-- Sidebar Navigation -->
                <div class="col-md-3">
                    <div class="p-4">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <button class="nav-link active" id="v-pills-personal-tab" data-bs-toggle="pill" data-bs-target="#v-pills-personal" type="button" role="tab" aria-controls="v-pills-personal" aria-selected="true">
                                <i class="bi bi-person me-2"></i>Personal Info
                            </button>
                            <button class="nav-link" id="v-pills-security-tab" data-bs-toggle="pill" data-bs-target="#v-pills-security" type="button" role="tab" aria-controls="v-pills-security" aria-selected="false">
                                <i class="bi bi-shield-lock me-2"></i>Password & Security
                            </button>
                            <button class="nav-link" id="v-pills-allergies-tab" data-bs-toggle="pill" data-bs-target="#v-pills-allergies" type="button" role="tab" aria-controls="v-pills-allergies" aria-selected="false">
                                <i class="bi bi-heart-pulse me-2"></i>Allergy Information
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="col-md-9">
                    <div class="tab-content" id="v-pills-tabContent">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane fade show active" id="v-pills-personal" role="tabpanel" aria-labelledby="v-pills-personal-tab">
                            <h3 class="section-title">Personal Information</h3>

                            <form method="post" asp-page-handler="UpdatePersonalInfo" class="needs-validation" novalidate>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control readonly-field" value="@Model.Profile.Name" readonly>
                                            <div class="form-text">First name cannot be changed</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control readonly-field" value="@Model.Profile.Surname" readonly>
                                            <div class="form-text">Last name cannot be changed</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control readonly-field" value="@Model.Profile.Email" readonly>
                                            <div class="form-text">Email cannot be changed</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">ID Number</label>
                                            <input type="text" class="form-control readonly-field" value="@Model.Profile.IDNumber" readonly>
                                            <div class="form-text">For verification purposes only</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="Profile.CellphoneNumber" class="form-label">Cellphone Number *</label>
                                            <input asp-for="Profile.CellphoneNumber" class="form-control"
                                                   pattern="^0[0-9]{9}$"
                                                   maxlength="10"
                                                   required />
                                            <span asp-validation-for="Profile.CellphoneNumber" class="text-danger"></span>
                                            <div class="valid-feedback">Looks good!</div>
                                            <div class="invalid-feedback">Please enter a valid 10-digit cellphone number starting with 0</div>
                                            <div class="form-text">We'll use this for delivery updates and notifications</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-2"></i>Update Personal Information
                                    </button>
                                    <a asp-controller="CustomerDashboard" asp-action="UploadPrescription" class="btn btn-secondary">
                                        <i class="bi bi-house me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                            </form>
                        </div>

                        <!-- Password & Security Tab -->
                        <div class="tab-pane fade" id="v-pills-security" role="tabpanel" aria-labelledby="v-pills-security-tab">
                            <h3 class="section-title">Change Password</h3>

                            <div class="info-box">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Password Requirements:</strong> At least 6 characters with both letters and numbers for security.
                            </div>

                            <form method="post" asp-page-handler="ChangePassword" class="needs-validation" novalidate>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="Profile.CurrentPassword" class="form-label">Current Password *</label>
                                            <input asp-for="Profile.CurrentPassword" class="form-control"
                                                   type="password"
                                                   required />
                                            <span asp-validation-for="Profile.CurrentPassword" class="text-danger"></span>
                                            <div class="valid-feedback">Looks good!</div>
                                            <div class="invalid-feedback">Please enter your current password</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="Profile.NewPassword" class="form-label">New Password *</label>
                                            <input asp-for="Profile.NewPassword" class="form-control"
                                                   type="password"
                                                   pattern="^(?=.*[A-Za-z])(?=.*\d).{6,}$"
                                                   required />
                                            <span asp-validation-for="Profile.NewPassword" class="text-danger"></span>
                                            <div class="valid-feedback">Strong password!</div>
                                            <div class="invalid-feedback">Password must be at least 6 characters with letters and numbers</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="Profile.ConfirmNewPassword" class="form-label">Confirm New Password *</label>
                                            <input asp-for="Profile.ConfirmNewPassword" class="form-control"
                                                   type="password"
                                                   required />
                                            <span asp-validation-for="Profile.ConfirmNewPassword" class="text-danger"></span>
                                            <div class="valid-feedback">Passwords match!</div>
                                            <div class="invalid-feedback">Please confirm your new password</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-key me-2"></i>Update Password
                                    </button>
                                    <a asp-controller="CustomerDashboard" asp-action="UploadPrescription" class="btn btn-secondary">
                                        <i class="bi bi-house me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                            </form>
                        </div>

                        <!-- Allergy Information Tab -->
                        <div class="tab-pane fade" id="v-pills-allergies" role="tabpanel" aria-labelledby="v-pills-allergies-tab">
                            <h3 class="section-title">Allergy Information</h3>

                            <div class="info-box">
                                <i class="bi bi-heart-pulse me-2"></i>
                                <strong>Your safety is important to us!</strong> Keeping your allergy information up to date helps us ensure your medications are always safe for you.
                            </div>

                            <!-- Current Allergies -->
                            @if (Model.CurrentAllergies.Any())
                            {
                                <div class="current-allergies">
                                    <h5><i class="bi bi-list-check me-2"></i>Your Current Allergies</h5>
                                    @foreach (var allergy in Model.CurrentAllergies)
                                    {
                                        <span class="allergy-tag">
                                            <i class="bi bi-exclamation-triangle me-1"></i>@allergy
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="current-allergies">
                                    <h5><i class="bi bi-check-circle me-2"></i>No Allergies Recorded</h5>
                                    <p class="mb-0">You currently have no allergies recorded in our system.</p>
                                </div>
                            }

                            <form method="post" asp-page-handler="UpdateAllergies">
                                <div class="mb-4">
                                    <label class="form-label fw-semibold mb-3">Update your allergy information:</label>
                                    <div class="allergy-checkboxes">
                                        @if (Model.Profile.AllergyList != null && Model.Profile.AllergyList.Any())
                                        {
                                            @foreach (var allergy in Model.Profile.AllergyList)
                                            {
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           value="@allergy.Value"
                                                           id="allergy_@allergy.Value"
                                                           name="SelectedAllergyIds"
                                                    @(Model.Profile.SelectedAllergyIds.Contains(int.Parse(allergy.Value)) ? "checked" : "")>
                                                    <label class="form-check-label" for="allergy_@allergy.Value">
                                                        @allergy.Text
                                                    </label>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-center text-muted py-4">
                                                <i class="bi bi-info-circle me-2"></i>
                                                No allergy options available at the moment
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>Tip:</strong> Leave all boxes unchecked if you have no allergies. This helps us provide you with safe medication recommendations.
                                </div>

                                <div class="button-group">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Update Allergy Information
                                    </button>
                                    <a asp-controller="CustomerDashboard" asp-action="UploadPrescription" class="btn btn-secondary">
                                        <i class="bi bi-house me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Bootstrap validation
            const forms = document.querySelectorAll('.needs-validation');
            forms.forEach(form => {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });

            // Cellphone number formatting
            const cellphoneInput = document.querySelector('#Profile_CellphoneNumber');
            if (cellphoneInput) {
                cellphoneInput.addEventListener('input', function (e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length > 10) {
                        this.value = this.value.slice(0, 10);
                    }
                });

                cellphoneInput.addEventListener('blur', function () {
                    if (this.value.length > 0 && !this.value.startsWith('0')) {
                        this.setCustomValidity('Cellphone number must start with 0');
                    } else if (this.value.length !== 10 && this.value.length > 0) {
                        this.setCustomValidity('Cellphone number must be exactly 10 digits');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Real-time validation feedback
            const inputs = document.querySelectorAll('.form-control[required]');
            inputs.forEach(input => {
                input.addEventListener('blur', function () {
                    if (this.value.trim() !== '') {
                        if (this.checkValidity()) {
                            this.classList.add('is-valid');
                            this.classList.remove('is-invalid');
                        } else {
                            this.classList.add('is-invalid');
                            this.classList.remove('is-valid');
                        }
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });

                input.addEventListener('input', function () {
                    if (this.value.trim() !== '') {
                        if (this.checkValidity()) {
                            this.classList.add('is-valid');
                            this.classList.remove('is-invalid');
                        } else {
                            this.classList.add('is-invalid');
                            this.classList.remove('is-valid');
                        }
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
            });

            // Form submission loading states
            forms.forEach(form => {
                form.addEventListener('submit', function () {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        const originalText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Updating...';

                        // Re-enable button after 5 seconds (in case of error)
                        setTimeout(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }, 5000);
                    }
                });
            });

            // Confirm password validation
            const newPasswordInput = document.querySelector('#Profile_NewPassword');
            const confirmPasswordInput = document.querySelector('#Profile_ConfirmNewPassword');

            if (newPasswordInput && confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function () {
                    if (this.value !== newPasswordInput.value) {
                        this.setCustomValidity('Passwords do not match');
                    } else {
                        this.setCustomValidity('');
                    }
                });

                newPasswordInput.addEventListener('input', function () {
                    if (confirmPasswordInput.value !== '' && confirmPasswordInput.value !== this.value) {
                        confirmPasswordInput.setCustomValidity('Passwords do not match');
                    } else {
                        confirmPasswordInput.setCustomValidity('');
                    }
                });
            }

            // Auto-hide success messages after 5 seconds
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(successAlert);
                    bsAlert.close();
                }, 5000);
            }
        });
    </script>
}